<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Echoplex Digital Pro Plus</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap');

        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }

        /* Main container - CHANGED ASPECT RATIO AND REMOVED PROPERTIES AS REQUESTED */
        .echoplex-container {
            position: relative;
            width: 95vw;
            max-width: 1400px;
            aspect-ratio: 1400 / 162;
            border: 2px solid #111;
            user-select: none;
            background-repeat: no-repeat;
        }

        /* Background image layer */
        .echoplex-background {
            position: absolute;
            width: 100%;
            height: 100%;
            background: url('https://i.ibb.co/0jtXdtfz/axa.png') no-repeat center;
            background-size: cover;
        }

        /* Brand and model text - CONVERTED TO RESPONSIVE */
        .brand-text {
            position: absolute;
            left: 5%;
            top: 15%;
            font-size: 2.5vw;
            font-style: italic;
            font-weight: bold;
            color: #ddd;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .model-text {
            position: absolute;
            right: 25%;
            top: 15%;
            font-size: 1.8vw;
            font-style: italic;
            color: #ccc;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        /* Gibson logo area */
        .gibson-logo {
            position: absolute;
            right: 5%;
            top: 10%;
            width: 8%;
            height: 25%;
            background: linear-gradient(135deg, #c00 0%, #800 100%);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.5vw;
            font-style: italic;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }

        /* KNOBS - NOW FULLY RESPONSIVE */
        .knob {
            position: absolute;
            width: 2.86%; /* 40px / 1400px */
            height: 11.43%; /* 40px / 350px */
            border-radius: 50%;
            cursor: grab;
        }

        .knob:active {
            cursor: grabbing;
        }

        .knob-image {
            position: absolute;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 30% 30%, #666, #222);
            border-radius: 50%;
            box-shadow: 
                0 5px 15px rgba(0,0,0,0.8),
                inset 0 -2px 5px rgba(0,0,0,0.5),
                inset 0 2px 2px rgba(255,255,255,0.2);
            transform-origin: center center;
            pointer-events: none;
        }

        .knob-indicator {
            position: absolute;
            width: 3px;
            height: 40%;
            background: #fff;
            left: 50%;
            top: 10%;
            transform: translateX(-50%);
            box-shadow: 0 0 3px rgba(255,255,255,0.5);
            pointer-events: none;
        }

        /* Knob labels - RESPONSIVE POSITIONING */
        .knob-label {
            position: absolute;
            color: #aaa;
            font-size: 0.9vw;
            text-align: center;
            white-space: nowrap;
            transform: translateX(-50%);
        }

        /* Level indicator lights - RESPONSIVE */
        .level-light {
            position: absolute;
            width: 5.5px; /* 8px / 1400px */
            height: 5.5px; /* 8px / 350px */
            border-radius: 50%;
            background: #300;
            box-shadow: inset 0 0 2px rgba(0,0,0,0.5);
        }

        .level-light.green {
            background: #0f0;
            box-shadow: 0 0 8px #0f0, inset 0 0 3px rgba(255,255,255,0.5);
        }

        .level-light.yellow {
            background: #ff0;
            box-shadow: 0 0 8px #ff0, inset 0 0 3px rgba(255,255,255,0.5);
        }

        .level-light.red {
            background: #f00;
            box-shadow: 0 0 8px #f00, inset 0 0 3px rgba(255,255,255,0.5);
        }

        /* Display section - RESPONSIVE */
        .display-section {
            position: absolute;
            left: 40%;
            top: 28%;
            width: 30%;
            height: 25%;
            background: #111;
            border: 2px solid #333;
            border-radius: 5px;
            padding: 1%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .loop-display {
            font-family: 'Orbitron', monospace;
            font-size: 2.8vw;
            color: #f00;
            text-shadow: 0 0 10px #f00;
            letter-spacing: -0.08em;
            background: #000;
            padding: 0.5% 1%;
            border-radius: 3px;
            min-width: 60%;
        }

        .multiple-display {
            font-family: 'Orbitron', monospace;
            font-size: 1.2vw;
            color: #f00;
            text-shadow: 0 0 8px #f00;
            background: #000;
            padding: 0.5% 1%;
            border-radius: 3px;
            min-width: 25%;
            text-align: center;
        }

        /* Display labels - RESPONSIVE */
        .display-labels {
            position: absolute;
            left: 40%;
            top: 55%;
            width: 30%;
            display: flex;
            justify-content: space-around;
            color: #888;
            font-size: 0.7vw;
        }

        /* Button control hitbox */
        .control {
            position: absolute;
            cursor: pointer;
        }

        .button {
            transition: all 0.1s;
            border-radius: 50%;
        	width: 50px;         /* ensure width and height are equal */
    		height: 50px;
            /* background: rgba(0,0,255,0.2); /* Uncomment to see hitboxes */
        }

        .button:active {
            transform: scale(0.95);
        }

        .button-image {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, #f8f8f8, #d0d0d0);
            border: 1px solid #888;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.5);
            pointer-events: none;
        }

        /* Button labels - RESPONSIVE POSITIONING */
        .button-label {
            position: absolute;
            color: #ccc;
            font-size: 0.65vw;
            text-align: center;
            white-space: nowrap;
            transform: translateX(-50%);
        }

        /* Button group for vertical alignment */
        .button-row {
            position: absolute;
            display: flex;
            gap: 3%;
        }

        /* Status LED under each button - RESPONSIVE */
        .status-led {
            position: absolute;
            bottom: -86%;
            left: 50%;
            transform: translateX(-50%);
            width: 29%; /* 6px relative to 25px button */
            height: 24%;
            border-radius: 50%;
            background: #111;
            box-shadow: inset 0 0 2px rgba(0,0,0,0.8);
        }

        .status-led.green {
            background: #0f0;
            box-shadow: 0 0 8px #0f0, inset 0 0 2px rgba(255,255,255,0.5);
        }

        .status-led.red {
            background: #f00;
            box-shadow: 0 0 8px #f00, inset 0 0 2px rgba(255,255,255,0.5);
        }

        .status-led.orange {
            background: #f80;
            box-shadow: 0 0 8px #f80, inset 0 0 2px rgba(255,255,255,0.5);
        }

        /* Parameter matrix grid - RESPONSIVE */
        .parameter-matrix {
            position: absolute;
            left: 53%;
            bottom: 13%;
            width: 39%;
            height: 22%;
            background: rgba(34, 34, 34, 0.26);
            border:1px solid rgba(68, 68, 68, 0.29);
            border-radius: 3px;
            padding: 0.5%;
        }

        .matrix-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 25%;
            color: #666;
            font-size: 0.6vw;
        }

        .matrix-cell {
            text-align: center;
            width: 12.5%;
            flex: 1;
        }

        .matrix-cell:first-child {
            text-align: left;
            padding-left: 2%;
        }

        /* Row indicator lights - RESPONSIVE */
        .row-indicator {
            position: absolute;
            width: 0.71%; /* 10px / 1400px */
            height: 2.86%; /* 10px / 350px */
            border-radius: 50%;
            background: #111;
            box-shadow: inset 0 0 3px rgba(0,0,0,0.8);
        }

        .row-indicator.active {
            background: #f80;
            box-shadow: 0 0 8px #f80, inset 0 0 2px rgba(255,255,255,0.5);
        }

        .row-label {
            position: absolute;
            left: -50px;
            
            font-size: 0.65vw;
            color: #000;
            white-space: nowrap;
            width: 45px;
            text-align: right;
        }

        /* Power button - RESPONSIVE */
        .power-button {
            position: absolute;
            width: 2.14%; /* 30px / 1400px */
            height: 17.14%; /* 60px / 350px */
            background: linear-gradient(to bottom, #800, #400);
            border: 2px solid #600;
            border-radius: 5px;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.5);
        }

        .power-button.on {
            background: linear-gradient(to bottom, #f00, #800);
            box-shadow: 0 0 15px #f00;
        }

        /* Visual tempo guide dots - RESPONSIVE */
        .tempo-dot {
            position: absolute;
            width: 0.29%; /* 4px / 1400px */
            height: 1.14%; /* 4px / 350px */
            border-radius: 50%;
            background: #400;
        }

        .tempo-dot.active {
            background: #f00;
            box-shadow: 0 0 6px #f00;
        }

        /* Value display */
        .value-display {
            position: absolute;
            background: rgba(0,0,0,0.9);
            color: #0ff;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-family: monospace;
            pointer-events: none;
            z-index: 1000;
            border: 1px solid #0ff;
        }
    </style>
</head>
<body>
    <div class="echoplex-container">
        <!-- Background image layer -->
        <div class="echoplex-background"></div>

        <!-- Branding -->
        <div class="brand-text">Echoplex</div>
        <div class="model-text">Digital Pro Plus</div>

        <!-- KNOBS - NOW WITH PERCENTAGE POSITIONING -->
        <!-- Input Knob -->
        <div class="control knob" style="left: 1.3%; top: 56%; width: 2.8%; height: 22.5%;" data-param="input" data-min="0" data-max="127" data-value="64">
            <div class="knob-image">
                <div class="knob-indicator"></div>
            </div>
        </div>
        <div class="knob-label" style="left: 12.43%; top: 62%;">Input</div>

        <!-- Output Knob -->
        <div class="control knob" style="left: 7.5%; top: 56%; width: 2.8%; height: 22.5%;" data-param="output" data-min="0" data-max="127" data-value="64">
            <div class="knob-image">
                <div class="knob-indicator"></div>
            </div>
        </div>
        <div class="knob-label" style="left: 17.43%; top: 62%;">Output</div>

        <!-- Mix Knob -->
        <div class="control knob" style="left: 21.2%; top: 56%; width: 2.8%; height: 22.5%;" data-param="mix" data-min="0" data-max="127" data-value="64">
            <div class="knob-image">
                <div class="knob-indicator"></div>
            </div>
        </div>
        <div class="knob-label" style="left: 29.43%; top: 62%;">Mix</div>

        <!-- Feedback Knob -->
        <div class="control knob" style="left: 26.8%; top: 56%; width: 2.8%; height: 22.5%;" data-param="feedback" data-min="0" data-max="127" data-value="95">
            <div class="knob-image">
                <div class="knob-indicator"></div>
            </div>
        </div>
        <div class="knob-label" style="left: 34.43%; top: 62%;">Feedback</div>

        <!-- Level indicator lights -->
        <div class="level-light" id="input-level" style="left: 13%; top: 73%; width: 0.7%; height: 6%;"></div>
        <div class="level-light" id="feedback-level" style="left: 16.9%; top: 73%; width: 0.7%; height: 6%;""></div>

        <!-- Display Section -->
        <div class="display-section" style="left: 32.8%; top:32%; width: 16.9%; height: 27%";>
            <div class="loop-display" id="loop-display" style="left: 23.8%; top:32%; width: 2.9%; height: 77%"; >0.0</div>
            <div class="multiple-display" id="multiple-display"></div>
        </div>
        <div class="display-labels">
            <span>LOOP</span>
            <span>LOOPTIME</span>
            <span>MULTIPLE</span>
        </div>

        <!-- Visual tempo dots -->
        <div class="tempo-dot" id="tempo-dot-right" style="right: 45%; top: 52%;"></div>
        <div class="tempo-dot" id="tempo-dot-left" style="right: 47%; top: 52%;"></div>

        <!-- BUTTONS - SINGLE ROW OF 8 -->
        <div class="control button" style="left: 54.3%; top: 9.0%; width: 2.6%; height: 21.0%;" data-function="parameters">
            <div class="button-image">
            </div>
        </div>
        <div class="button-label" style="left: 49.5%; top: 28%;">Parameters</div>

        <div class="control button" style="left: 61%; top: 10.3%; width: 2.6%; height: 21%;" data-function="record">
            <div class="button-image">
                <div class="status-led green"></div>
            </div>
        </div>
        <div class="button-label" style="left: 55.5%; top: 28%;">Record</div>

        <div class="control button" style="left: 65.5%; top: 10.3%; width: 2.6%; height: 21%;" data-function="overdub">
            <div class="button-image">
                <div class="status-led green"></div>
            </div>
        </div>
        <div class="button-label" style="left: 61.5%; top: 28%;">Overdub</div>

        <div class="control button" style="left: 70%; top: 10.3%; width: 2.6%; height: 21%;" data-function="multiply">
            <div class="button-image">
                <div class="status-led green"></div>
            </div>
        </div>
        <div class="button-label" style="left: 67.5%; top: 28%;">Multiply</div>

        <div class="control button" style="left: 74.5%; top: 10.3%; width: 2.6%; height: 21%;" data-function="insert">
            <div class="button-image">
                <div class="status-led green"></div>
            </div>
        </div>
        <div class="button-label" style="left: 73.5%; top: 28%;">Ins/Rev</div>

        <div class="control button" style="left: 79.2%; top: 10.3%; width: 2.6%; height: 21%;" data-function="mute">
            <div class="button-image">
                <div class="status-led green" ></div>
            </div>
        </div>
        <div class="button-label" style="left: 79.5%; top: 28%;">Mute</div>

        <div class="control button" style="left: 83.6%; top: 10.3%; width: 2.6%; height: 21%;" data-function="undo">
            <div class="button-image">
                <div class="status-led green"></div>
            </div>
        </div>
        <div class="button-label" style="left: 85.5%; top: 28%;">Undo</div>

        <div class="control button" style="left: 88.3%; top: 10.3%; width: 2.6%; height: 21%;" data-function="nextloop">
            <div class="button-image">
                <div class="status-led green"></div>
            </div>
        </div>
        <div class="button-label" style="left: 91.5%; top: 28%;">NextLoop</div>  <!-- Row Indicator Lights - RESPONSIVE POSITIONING -->
        <div class="row-indicator" style="left: 56.3%; top: 52%; width: 0.7%; height: 6%;" id="loops-led">
            <div class="row-label" style="transform: translateX(-18%) translateY(-14%);" >Loops</div>
        </div>
        <div class="row-indicator" style="left: 57.5%; top: 62.5%; width: 0.7%; height: 6%;" id="midi-led">
            <div class="row-label" style="transform: translateX(-22%);">MIDI</div>
        </div>
        <div class="row-indicator" style="left: 58.6%; top: 72%; width: 0.7%; height: 6%;" id="switches-led">
            <div class="row-label" style="transform: translateY(-32%); translateX(-60%)">Switches</div>
        </div>
        <div class="row-indicator" style="left: 59.6%; top: 82%; width: 0.7%; height: 6%;" id="timing-led">
            <div class="row-label" style="transform: translateY(-34%) translateX(-20%);">Timing</div>
        </div>

        <!-- Parameter Matrix -->
        <div class="parameter-matrix">
            <div class="matrix-row">
                <div class="matrix-cell">Timing</div>
                <div class="matrix-cell">Loop/Delay</div>
                <div class="matrix-cell">Quantize</div>
                <div class="matrix-cell">8ths/Cycle</div>
                <div class="matrix-cell">Sync</div>
                <div class="matrix-cell">Threshold</div>
                <div class="matrix-cell">Reverse</div>
                <div class="matrix-cell">StartPoint</div>
            </div>
            <div class="matrix-row">
                <div class="matrix-cell">Switches</div>
                <div class="matrix-cell">RecordMode</div>
                <div class="matrix-cell">OverdubMode</div>
                <div class="matrix-cell">RoundMode</div>
                <div class="matrix-cell">InsertMode</div>
                <div class="matrix-cell">MuteMode</div>
                <div class="matrix-cell">Overflow</div>
                <div class="matrix-cell">Presets</div>
            </div>
            <div class="matrix-row">
                <div class="matrix-cell">MIDI</div>
                <div class="matrix-cell">Channel</div>
                <div class="matrix-cell">ControlSource</div>
                <div class="matrix-cell">Source #</div>
                <div class="matrix-cell">VolumeCont</div>
                <div class="matrix-cell">FeedBkCont</div>
                <div class="matrix-cell">Dump</div>
                <div class="matrix-cell">Load</div>
            </div>
            <div class="matrix-row">
                <div class="matrix-cell">Loops</div>
                <div class="matrix-cell">MoreLoops</div>
                <div class="matrix-cell">AutoRecord</div>
                <div class="matrix-cell">LoopCopy</div>
                <div class="matrix-cell">SwitchQuant</div>
                <div class="matrix-cell">LoopTrig</div>
                <div class="matrix-cell">Velocity</div>
                <div class="matrix-cell">SamplerStyle</div>
            </div>
        </div>

        <!-- Power Section - RESPONSIVE POSITIONING -->
        <div class="power-button" style="right: 0.7%; top: 43%;" id="power-button"></div>
        <div class="button-label" style="left: 95.43%; top: 60%;">POWER</div>
    </div>

    <script>
        // Echoplex state management
        const echoplexState = {
            power: false,
            loopTime: 0,
            isRecording: false,
            isOverdubbing: false,
            isMultiplying: false,
            isMuted: false,
            currentCycle: 0,
            parameterMode: 0, // 0 = play mode, 1-4 = parameter rows
            insertMode: 'insert', // insert, reverse, halfspeed, substitute
            controlValues: {
                input: 64,
                output: 64,
                mix: 64,
                feedback: 95
            }
        };

        let recordingInterval = null;
        let valueDisplay = null;
        let longPressTimer = null;
        let buttonPressStart = 0;

        // Initialize displays
        const loopDisplay = document.getElementById('loop-display');
        const multipleDisplay = document.getElementById('multiple-display');

        // Initialize power button
        const powerButton = document.getElementById('power-button');
        powerButton.addEventListener('click', togglePower);

        function togglePower() {
            echoplexState.power = !echoplexState.power;
            powerButton.classList.toggle('on', echoplexState.power);
            
            if (echoplexState.power) {
                // Show startup sequence
                loopDisplay.textContent = '1.0';
                setTimeout(() => {
                    loopDisplay.textContent = '198';
                    setTimeout(() => {
                        loopDisplay.textContent = '0.0';
                    }, 2000);
                }, 1000);
            } else {
                // Power off - reset everything
                loopDisplay.textContent = '';
                multipleDisplay.textContent = '';
                stopRecording();
                clearAllLEDs();
            }
        }

        // Button functionality
        document.querySelectorAll('.button').forEach(button => {
            const func = button.dataset.function;
            const led = button.querySelector('.status-led');
            
            button.addEventListener('mousedown', (e) => {
                if (!echoplexState.power) return;
                
                buttonPressStart = Date.now();
                
                // Set up long press detection
                longPressTimer = setTimeout(() => {
                    handleLongPress(func, led);
                }, 500);
            });
            
            button.addEventListener('mouseup', (e) => {
                if (!echoplexState.power) return;
                
                clearTimeout(longPressTimer);
                const pressDuration = Date.now() - buttonPressStart;
                
                if (pressDuration < 500) {
                    handleShortPress(func, led);
                }
            });
        });

        function handleShortPress(func, led) {
            switch(func) {
                case 'parameters':
                    cycleParameterMode();
                    break;
                case 'record':
                    toggleRecord(led);
                    break;
                case 'overdub':
                    toggleOverdub(led);
                    break;
                case 'multiply':
                    toggleMultiply(led);
                    break;
                case 'insert':
                    handleInsert(led);
                    break;
                case 'mute':
                    toggleMute(led);
                    break;
                case 'undo':
                    performUndo();
                    break;
                case 'nextloop':
                    switchToNextLoop();
                    break;
            }
        }

        function handleLongPress(func, led) {
            switch(func) {
                case 'parameters':
                    // Exit parameter mode immediately
                    echoplexState.parameterMode = 0;
                    updateParameterLEDs();
                    break;
                case 'record':
                    // Reset current loop
                    echoplexState.loopTime = 0;
                    loopDisplay.textContent = '0.0';
                    stopRecording();
                    led.className = 'status-led green';
                    break;
                case 'multiply':
                    // General reset if loop is reset
                    if (echoplexState.loopTime === 0) {
                        led.className = 'status-led orange';
                        // Perform general reset
                    }
                    break;
                case 'undo':
                    // Long undo
                    loopDisplay.textContent = 'L.Un';
                    setTimeout(() => {
                        loopDisplay.textContent = echoplexState.loopTime.toFixed(1);
                    }, 1000);
                    break;
            }
        }

        function cycleParameterMode() {
            echoplexState.parameterMode = (echoplexState.parameterMode + 1) % 5;
            updateParameterLEDs();
            
            if (echoplexState.parameterMode > 0) {
                multipleDisplay.textContent = `P${echoplexState.parameterMode}`;
            } else {
                multipleDisplay.textContent = '';
            }
        }

        function updateParameterLEDs() {
            document.getElementById('timing-led').classList.toggle('active', echoplexState.parameterMode === 1);
            document.getElementById('switches-led').classList.toggle('active', echoplexState.parameterMode === 2);
            document.getElementById('midi-led').classList.toggle('active', echoplexState.parameterMode === 3);
            document.getElementById('loops-led').classList.toggle('active', echoplexState.parameterMode === 4);
        }

        function toggleRecord(led) {
            if (echoplexState.isRecording) {
                // Stop recording
                stopRecording();
                led.className = 'status-led green';
            } else {
                // Start recording
                echoplexState.isRecording = true;
                led.className = 'status-led red';
                echoplexState.loopTime = 0;
                
                recordingInterval = setInterval(() => {
                    echoplexState.loopTime += 0.1;
                    loopDisplay.textContent = echoplexState.loopTime.toFixed(1);
                }, 100);
            }
        }

        function stopRecording() {
            echoplexState.isRecording = false;
            clearInterval(recordingInterval);
        }

        function toggleOverdub(led) {
            echoplexState.isOverdubbing = !echoplexState.isOverdubbing;
            led.className = echoplexState.isOverdubbing ? 'status-led red' : 'status-led green';
        }

        function toggleMultiply(led) {
            if (echoplexState.isMultiplying) {
                // Stop multiplying
                echoplexState.isMultiplying = false;
                led.className = 'status-led green';
            } else {
                // Start multiplying
                echoplexState.isMultiplying = true;
                led.className = 'status-led red';
                echoplexState.currentCycle = 1;
                multipleDisplay.textContent = `C ${echoplexState.currentCycle}`;
                
                // Simulate cycle counting
                const cycleInterval = setInterval(() => {
                    if (echoplexState.isMultiplying) {
                        echoplexState.currentCycle++;
                        multipleDisplay.textContent = `C ${echoplexState.currentCycle}`;
                    } else {
                        clearInterval(cycleInterval);
                    }
                }, 2000); // Assuming 2 second cycles
            }
        }

        function handleInsert(led) {
            switch(echoplexState.insertMode) {
                case 'reverse':
                    led.className = led.className.includes('red') ? 'status-led green' : 'status-led red';
                    loopDisplay.textContent = led.className.includes('red') ? 'rE' : 'Fd';
                    setTimeout(() => {
                        loopDisplay.textContent = echoplexState.loopTime.toFixed(1);
                    }, 1000);
                    break;
                case 'halfspeed':
                    led.className = led.className.includes('red') ? 'status-led green' : 'status-led red';
                    loopDisplay.textContent = led.className.includes('red') ? 'H.SP' : 'F.SP';
                    setTimeout(() => {
                        if (led.className.includes('red')) {
                            // Show doubled time for half speed
                            loopDisplay.textContent = (echoplexState.loopTime * 2).toFixed(1);
                        } else {
                            loopDisplay.textContent = echoplexState.loopTime.toFixed(1);
                        }
                    }, 1000);
                    break;
                default:
                    // Regular insert
                    led.className = led.className.includes('red') ? 'status-led green' : 'status-led red';
                    break;
            }
        }

        function toggleMute(led) {
            echoplexState.isMuted = !echoplexState.isMuted;
            led.className = echoplexState.isMuted ? 'status-led red' : 'status-led green';
        }

        function performUndo() {
            loopDisplay.textContent = 'S.Un';
            setTimeout(() => {
                loopDisplay.textContent = echoplexState.loopTime.toFixed(1);
            }, 1000);
        }

        function switchToNextLoop() {
            // Simulate switching to next loop
            loopDisplay.textContent = 'L 2';
            setTimeout(() => {
                loopDisplay.textContent = '0.0';
            }, 1000);
        }

        function clearAllLEDs() {
            document.querySelectorAll('.status-led').forEach(led => {
                led.className = 'status-led';
            });
        }

        // Knob functionality
        document.querySelectorAll('.knob').forEach(knob => {
            setupKnob(knob);
        });

        function setupKnob(knob) {
            const param = knob.dataset.param;
            const min = parseFloat(knob.dataset.min);
            const max = parseFloat(knob.dataset.max);
            const knobImage = knob.querySelector('.knob-image');
            
            let isDragging = false;
            let startY = 0;
            let startValue = echoplexState.controlValues[param];
            const totalRotationRange = 270;

            // Set initial rotation
            const initialPercentage = (startValue - min) / (max - min);
            let startRotation = (initialPercentage * totalRotationRange) - 135;
            knobImage.style.transform = `rotate(${startRotation}deg)`;

            knob.addEventListener('mousedown', (e) => {
                if (!echoplexState.power) return;
                
                e.preventDefault();
                isDragging = true;
                startY = e.clientY;
                startValue = echoplexState.controlValues[param];
                const percentage = (startValue - min) / (max - min);
                startRotation = (percentage * totalRotationRange) - 135;
                
                // Show feedback level for feedback knob
                if (param === 'feedback') {
                    loopDisplay.textContent = Math.round(startValue);
                }
                
                createValueDisplay(e.pageX, e.pageY, formatValue(param, startValue));
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const deltaY = startY - e.clientY;
                const sensitivity = 200 / window.innerHeight; 
                const deltaRotation = deltaY * sensitivity * 1.5;
                
                let newRotation = startRotation + deltaRotation;
                newRotation = Math.max(-135, Math.min(135, newRotation));
                
                knobImage.style.transform = `rotate(${newRotation}deg)`;
                
                // Update value
                const percentage = (newRotation + 135) / totalRotationRange;
                echoplexState.controlValues[param] = min + (max - min) * percentage;
                
                // Update feedback display
                if (param === 'feedback') {
                    loopDisplay.textContent = Math.round(echoplexState.controlValues[param]);
                }
                
                updateValueDisplay(e.pageX, e.pageY, formatValue(param, echoplexState.controlValues[param]));
                
                // Update level LEDs
                updateLevelLEDs(param);
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    removeValueDisplay();
                    
                    // Restore loop time display after 1 second
                    if (param === 'feedback') {
                        setTimeout(() => {
                            loopDisplay.textContent = echoplexState.loopTime.toFixed(1);
                        }, 1000);
                    }
                }
            });
        }

        function updateLevelLEDs(param) {
            if (param === 'input') {
                const inputLevel = document.getElementById('input-level');
                const level = echoplexState.controlValues.input / 127;
                
                if (level > 0.8) {
                    inputLevel.className = 'level-light red';
                } else if (level > 0.5) {
                    inputLevel.className = 'level-light yellow';
                } else if (level > 0.1) {
                    inputLevel.className = 'level-light green';
                } else {
                    inputLevel.className = 'level-light';
                }
            }
            
            if (param === 'feedback') {
                const feedbackLevel = document.getElementById('feedback-level');
                const level = echoplexState.controlValues.feedback / 127;
                
                if (level > 0.9) {
                    feedbackLevel.className = 'level-light red';
                } else if (level > 0.7) {
                    feedbackLevel.className = 'level-light yellow';
                } else if (level > 0.3) {
                    feedbackLevel.className = 'level-light green';
                } else {
                    feedbackLevel.className = 'level-light';
                }
            }
        }

        // Helper functions
        function formatValue(param, value) {
            return Math.round(value).toString();
        }

        function createValueDisplay(x, y, text) {
            removeValueDisplay();
            valueDisplay = document.createElement('div');
            valueDisplay.className = 'value-display';
            valueDisplay.textContent = text;
            valueDisplay.style.left = x + 15 + 'px';
            valueDisplay.style.top = y - 30 + 'px';
            document.body.appendChild(valueDisplay);
        }

        function updateValueDisplay(x, y, text) {
            if (valueDisplay) {
                valueDisplay.textContent = text;
                valueDisplay.style.left = x + 15 + 'px';
                valueDisplay.style.top = y - 30 + 'px';
            }
        }

        function removeValueDisplay() {
            if (valueDisplay && valueDisplay.parentNode) {
                document.body.removeChild(valueDisplay);
                valueDisplay = null;
            }
        }

        // Visual tempo guide simulation
        setInterval(() => {
            if (echoplexState.power && echoplexState.loopTime > 0) {
                // Blink timing LED at 8th notes
                const timingLed = document.getElementById('timing-led');
                timingLed.classList.add('active');
                setTimeout(() => timingLed.classList.remove('active'), 100);
            }
        }, 250);
    </script>
</body>
</html>

